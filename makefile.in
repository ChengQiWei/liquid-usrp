# Copyright (c) 2009, 2010, 2011 Joseph Gaeddert
# Copyright (c) 2009, 2010, 2011 Virginia Polytechnic
#                          Institute & State University
#
# This file is part of liquid.
#
# liquid is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# liquid is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with liquid.  If not, see <http://www.gnu.org/licenses/>.

# 
# Makefile for liquid SDR libraries, USRP applications
#
# Targets:
#    all  :  build library and all example programs
#

# paths
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
VPATH = @srcdir@
include_dirs	:= . include
vpath %.h $(include_dirs)

# programs
CC	:= @CC@
CXX	:= @CXX@
MV	:= mv -f
RM	:= rm -f
SED	:= sed
AR	:= ar
RANLIB	:= ranlib

##
## TARGET : all
##
all : libraries examples


# flags
INCLUDE_CFLAGS	= -I./ -I./include/
CFLAGS		+= $(INCLUDE_CFLAGS) -g -O2 -Wall -fPIC
CPPFLAGS	+= $(INCLUDE_CFLAGS) -g -O2 -Wall -fPIC
LDFLAGS		+= @LIBS@
ARFLAGS		= r

# library source files
library_src :=				\
	lib/iqpr.cc			\

# library header files
library_headers :=			\
	include/iqpr.h			\

# example programs
example_src :=				\
	src/flexframe_tx.cc		\
	src/flexframe_rx.cc		\
	src/iqpr_test.cc		\
	src/packet_rx.cc		\
	src/packet_tx.cc		\
	src/ping.cc			\
	src/ofdmflexframe_rx.cc		\
	src/ofdmflexframe_tx.cc		\

#	src/crdemo.cc
#	src/usrp_init_test.cc
#	src/usrp_io_test.cc
#	src/fmtx.cc 
#	src/framestats_rx.cc
#	src/framestats_tx.cc
#	src/gmsk_rx.cc
#	src/gmsk_tx.cc
#	src/jammer.cc
#	src/tx_rrc.cc
#	src/ofdmoqamframe_tx.cc
#	src/ofdmoqamframe_rx.cc
#	src/packetstream_rx.cc
#	src/packetstream_tx.cc
#	src/usrp_rx_gain_correction_test.cc
#	src/dsa_ofdmoqam.cc
#	src/firpfbch_tx.cc
#	src/tx_ofdmoqam.cc
#	src/cr.cc
#	src/test_usrp_standard_tx.cc
#	src/gr_usrp_rx_test.cc
#	src/ofdmoqamframe64_tx.cc
#	src/ofdmoqamframe64_rx.cc
#	src/gr_usrp_tx_test.cc


##
## TARGET : Shared Library
##

library_objs	= $(patsubst %.cc,%.o,$(library_src))

$(library_objs) : %.o : %.cc $(library_headers)

# Shared library
SHARED_LIB	= @SH_LIB@

.PHONY: libraries
libraries: libliquidusrp.a $(SHARED_LIB)

# liquid library definition
# TODO: link from module libraries, not object files (for compactness)
libliquidusrp.a: $(library_objs)
	$(AR) $(ARFLAGS) $@ $^
	$(RANLIB) $@

# darwin
#
# gcc -dynamiclib -install_name libliquidusrp.dylib -o libliquidusrp.dylib libmodem.a libutility.a 
libliquidusrp.dylib: $(library_objs)
	$(CC) $(LDFLAGS) -dynamiclib -install_name $@ -o $@ $^

# linux, et al
libliquidusrp.so: $(libraries)
	$(CC) $(LDFLAGS) -shared -Xlinker -soname=$@ -o $@ -Wl,-whole-archive $^ -Wl,-no-whole-archive



##
## TARGET : examples
##

example_objs	= $(patsubst %.cc,%.o,$(example_src))
example_progs	= $(patsubst %.cc,%,  $(example_src))

$(example_objs) : %.o : %.cc
	$(CXX) $(CPPFLAGS) -c $< -o $@

$(example_progs) : % : %.o libliquidusrp.a
	$(CXX) $(CPPFLAGS) $(LDFLAGS) $^ -o $@

examples: $(example_progs)

clean-examples:
	$(RM) $(example_objs)
	$(RM) $(example_progs)

##
## TARGET : clean
##
clean: clean-examples
	$(RM) $(library_objs)
