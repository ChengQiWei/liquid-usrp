# Copyright (c) 2009, 2010 Joseph Gaeddert
# Copyright (c) 2009, 2010 Virginia Polytechnic
#                          Institute & State University
#
# This file is part of liquid.
#
# liquid is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# liquid is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with liquid.  If not, see <http://www.gnu.org/licenses/>.

# 
# Makefile for liquid SDR libraries, USRP applications
#
# Targets:
#    all                 :   dynamic shared-library object (e.g. libliquidusrp.so)
#    install             :   install the dynamic shared library object and
#                            header file(s)
#    uninstall           :   uninstall the library and header file(s)
#    examples            :   build all example programs
#    clean               :   clean all targets
#

# paths
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
VPATH = @srcdir@
include_dirs	:= . include
vpath %.h $(include_dirs)

# programs
CC	:= @CC@
CXX	:= @CXX@
MV	:= mv -f
RM	:= rm -f
SED	:= sed
AR	:= ar
RANLIB	:= ranlib

# shared library object
SHARED_LIB	= @SH_LIB@

# flags
INCLUDE_CFLAGS	= $(addprefix -I ,$(include_dirs))
CFLAGS		+= $(INCLUDE_CFLAGS) -g -O2 -Wall -fPIC
CPPFLAGS	+= $(INCLUDE_CFLAGS) -g -O2 -Wall -fPIC
LDFLAGS		+= @LIBS@
ARFLAGS		= r

# library header files
library_headers	:=			\
	iqpr.h				\
	usrp_io.h			\
	usrp_rx_gain_correction.h

# library source files
library_src	:=			\
	@LEGACY_LIBS@			\
	lib/iqpr.cc			\
	lib/usrp_io.cc			\
	lib/usrp_rx_gain_correction.cc

# example programs
example_src	:=			\
	src/crdemo.cc			\
	src/usrp_init_test.cc		\
	src/usrp_io_test.cc		\
	src/fmtx.cc 			\
	src/framestats_rx.cc		\
	src/framestats_tx.cc		\
	src/gmsk_tx.cc			\
	src/jammer.cc 			\
	src/tx_rrc.cc			\
	src/flexframe_tx.cc 		\
	src/flexframe_rx.cc		\
	src/iqpr_test.cc		\
	src/packet_tx.cc 		\
	src/packet_rx.cc		\
	src/ping.cc			\
	src/ofdmframe64_tx.cc		\
	src/ofdmframe64_rx.cc		\
	src/ofdmoqamframe64_tx.cc	\
	src/ofdmoqamframe64_rx.cc	\
	src/ofdmoqamframe_tx.cc		\
	src/ofdmoqamframe_rx.cc		\
	src/firpfbch_tx.cc		\
	src/usrp_rx_gain_correction_test.cc
#	src/dsa_ofdmoqam.cc
#	src/tx_ofdmoqam.cc
#	src/cr.cc
#	src/test_usrp_standard_tx.cc
#	src/gr_usrp_rx_test.cc
#	src/gr_usrp_tx_test.cc

library_objs	= $(patsubst %.cc,%.o,$(library_src))
headers		= $(addprefix include/,$(library_headers))

##
## TARGET : Shared library
##
all: libliquidusrp.a $(SHARED_LIB)

# build library objects from source files
$(library_objs): %.o : %.cc $(headers)
	$(CXX) $(CPPFLAGS) -c $< -o $@

.PHONY: libraries
libraries: $(libraries)

# Liquid library definition
# TODO: link from module libraries, not object files (for compactness)
libliquidusrp.a: $(library_objs)
	$(AR) $(ARFLAGS) $@ $^
	$(RANLIB) $@

# darwin
#
# gcc -dynamiclib -install_name libliquidusrp.dylib -o libliquidusrp.dylib libmodem.a libutility.a 
libliquidusrp.dylib: $(objects)
	$(CXX) $(LDFLAGS) -dynamiclib -install_name $@ -o $@ $^

# linux, et al
libliquidusrp.so: $(libraries)
	$(CXX) $(LDFLAGS) -shared -Xlinker -soname=$@ -o $@ -Wl,-whole-archive $^ -Wl,-no-whole-archive

## 
## TARGET : install
##

# Installs the libraries and header files in the host system
install:
	@echo "installing..."
	mkdir -p $(exec_prefix)/lib
	install -m 644 -p $(SHARED_LIB) libliquidusrp.a $(exec_prefix)/lib
	mkdir -p $(prefix)/include
	mkdir -p $(prefix)/include/liquid
	install -m 644 -p include/usrp_io.h $(prefix)/include/liquid
	install -m 644 -p include/iqpr.h $(prefix)/include/liquid
	@echo ""
	@echo "---------------------------------------------------------"
	@echo "  liquid-usrp was successfully installed.     "
	@echo ""
	@echo "  On some machines (e.g. Linux) you should rebind your"
	@echo "  libraries by running 'ldconfig' to make the shared"
	@echo "  object available.  You might also need to modify your"
	@echo "  LD_LIBRARY_PATH environment variable to include the"
	@echo "  directory $(exec_prefix)"
	@echo "---------------------------------------------------------"
	@echo ""

## 
## TARGET : uninstall
##

# Uninstalls the libraries and header files in the host system
uninstall:
	@echo "uninstalling..."
	@echo "removing header \"$(prefix)/include/liquid/usrp_io.h\" ..."
	$(RM) $(prefix)/include/liquid/usrp_io.h
	@echo "removing header \"$(prefix)/include/liquid/iqpr.h\" ..."
	$(RM) $(prefix)/include/liquid/iqpr.h
	@echo "removing library \"$(exec_prefix)/lib/libliquidusrp.a\" ..."
	$(RM) $(exec_prefix)/lib/libliquidusrp.a
	@echo "removing library \"$(exec_prefix)/lib/$(SHARED_LIB)\" ..."
	$(RM) $(exec_prefix)/lib/$(SHARED_LIB)
	@echo "done."


##
## TARGET : examples
##

example_objs	= $(patsubst %.cc,%.o,$(example_src))
example_progs	= $(patsubst %.cc,%,  $(example_src))

$(example_objs) : %.o : %.cc
	$(CXX) $(CPPFLAGS) -c $< -o $@

$(example_progs) : % : %.o libliquidusrp.a
	$(CXX) $(CPPFLAGS) $(LDFLAGS) $^ -o $@

examples: $(example_progs)

clean-examples:
	$(RM) $(example_objs)
	$(RM) $(example_progs)

##
## TARGET : clean
##
clean: clean-examples
	$(RM) $(library_objs)
	$(RM) libliquidusrp.a
	$(RM) $(SHARED_LIB)
